# Azure Blob Storage Container Routing Fix

## Issue

The FLUX image generation service was incorrectly saving images to the "audio" container instead of the dedicated "images" container, even though the environment variables specified separate containers for different file types:

- `AZURE_STORAGE_CONTAINER_NAME=audio` (default)
- `AZURE_STORAGE_CONTAINER_IMAGES=images` (for images)
- `AZURE_STORAGE_CONTAINER_VIDEO=videos` (for videos)

## Root Cause

The AzureBlobService was always using the default container name (`AZURE_STORAGE_CONTAINER_NAME`) regardless of the blob path prefix. The FluxImageService was correctly using `images/${filename}` as the blob path, but the AzureBlobService wasn't interpreting this path to determine which container to use.

## Solution

Modified the AzureBlobService to:

1. **Read all container environment variables**:
   - `AZURE_STORAGE_CONTAINER_NAME` as default container
   - `AZURE_STORAGE_CONTAINER_IMAGES` for image files
   - `AZURE_STORAGE_CONTAINER_VIDEO` for video files

2. **Add path-based container routing**:
   - Paths starting with `images/` → use images container
   - Paths starting with `audio/` → use default container
   - Paths starting with `video/` → use video container
   - Paths starting with `subtitles/` → use default container
   - All other paths → use default container

3. **Updated all upload methods** to use the correct container based on the blob path

## Changes Made

### 1. Environment Variables (`.env`)
Updated `AZURE_STORAGE_CONTAINER_IMAGES=images` to use the correct container name.

### 2. AzureBlobService (`src/infrastructure/services/azure-blob.service.ts`)
- Added properties to store all container names
- Added `getContainerNameFromPath()` method for path-based routing
- Modified all upload methods to use the correct container
- Added logging to show which container is being used

## Verification

The container routing logic was tested with various path patterns:
- `images/flux-image-123.png` → `images` container
- `audio/audio-file.mp3` → `audio` container
- `video/video-file.mp4` → `videos` container
- `subtitles/sub-file.srt` → `audio` container
- `random-file.txt` → `audio` container

## Impact

- Images generated by FLUX will now be stored in the "images" container
- Audio files will continue to be stored in the "audio" container
- Video files will be stored in the "videos" container
- All existing functionality is preserved
- No breaking changes to the API

## Testing

The service was tested to ensure:
1. Images are correctly routed to the "images" container
2. Audio files continue to use the "audio" container
3. Video files are routed to the "videos" container
4. All upload methods work correctly with the new routing logic